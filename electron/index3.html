<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link rel="shortcut icon" type="image/png" href="images/favicon.png"/>
  <title>Fog Machine Server</title>

  <script src="js/materialize.min.js"></script>
  <link href="css/materialize.min.css" rel="stylesheet">

  <link href="css/index3.css" rel="stylesheet">
  <link href="css/boot.css" rel="stylesheet">
  <script src="js/vue.js"></script>

  <script src="js/izi-toast.min.js"></script>
  <link href="css/izi-toast.min.css" rel="stylesheet">

  <link href="fonts/jura.css" rel="stylesheet">
</head>

<body>
  <div class="main">
    <div class="main-left-col">
      <div class="left-nav-menu-header">
        Configure
      </div>
      <ul class="left-nav-menu">
        <li id="nav-server" class="left-nav-button waves-effect waves-purple nav-selected">
          <svg height="28" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M490.51,294.933v-78.613l-57.766-11.093c-3.883-13.594-9.354-26.549-16.092-38.657l32.701-48.337 l-55.602-55.587l-48.244,32.663c-12.309-6.885-25.492-12.177-39.338-16.109l-11.043-57.14h-78.614l-11.049,57.194 C191.568,83.21,178.34,88.654,166,95.592l-48.069-32.61l-55.589,55.562l32.726,48.312c-6.765,12.204-12.277,25.253-16.142,38.959 L21.49,216.841v78.613l57.659,11.078c3.917,13.661,9.426,26.676,16.228,38.834l-32.932,48.67l55.601,55.59l48.83-33.061 c12.103,6.719,25.048,11.981,38.629,15.852l11.099,57.524h78.614l11.096-57.531c13.684-3.894,26.717-9.275,38.896-16.063 l48.832,33.101l55.588-55.574l-33.072-48.836c6.805-12.221,12.383-25.298,16.279-39.032L490.51,294.933 M255.975,378.017 c-67.441,0-122.115-54.673-122.115-122.114s54.674-122.115,122.115-122.115c67.441,0,122.115,54.673,122.115,122.115 S323.416,378.017,255.975,378.017" fill="#F56F6C"/><path d="M254.297,378v0.006c0.439,0.006,0.877,0.01,1.316,0.01C255.322,378.014,255.289,378.005,254.297,378 M255.676,133.789c-0.461,0-0.92,0.004-1.379,0.011v0.005C255.313,133.801,255.359,133.791,255.676,133.789 M255.975,133.788 l-0.086,0.001c67.402,0.047,122.113,54.702,122.113,122.114c0,67.405-54.744,122.055-122.135,122.114h0.107 c67.441,0,122.115-54.673,122.115-122.114S323.416,133.788,255.975,133.788 M393.775,62.645l-0.014,0.009l55.592,55.579 l-32.701,48.337c6.738,12.108,12.209,25.063,16.092,38.657l57.766,11.093v78.613v-78.613l-57.766-11.093 c-3.883-13.594-9.268-26.549-16.006-38.657l32.66-48.337L393.775,62.645 M295.127,22.058h-40.83H295.127l11.043,57.14 c13.846,3.933,27.029,9.225,39.338,16.109l0.006-0.003c-12.307-6.884-25.494-12.174-39.338-16.106L295.127,22.058" fill="#F2F2F2"/><path d="M295.127,22.058h-40.83V133.8c0.459-0.007,0.918-0.011,1.379-0.011l0.125-0.001l0.088,0.001l0.086-0.001 c67.441,0,122.115,54.673,122.115,122.115s-54.674,122.114-122.115,122.114h-0.107h-0.109l-0.145-0.001 c-0.439,0-0.877-0.004-1.316-0.01v111.936h40.92l11.096-57.531c13.684-3.894,26.717-9.275,38.896-16.063l48.832,33.101 l55.588-55.574l-33.072-48.836c6.805-12.221,12.383-25.298,16.279-39.032l57.674-11.073v-78.613l-57.766-11.093 c-3.883-13.594-9.354-26.549-16.092-38.657l32.701-48.337l-55.592-55.579l-48.244,32.654l-0.004-0.003l-0.006,0.003 c-12.309-6.885-25.492-12.177-39.338-16.109L295.127,22.058" fill="#E96966"/><path d="M256.072,111.928c-79.505,0-143.957,64.451-143.957,143.956c0,79.503,64.452,143.955,143.957,143.955 c79.504,0,143.955-64.452,143.955-143.955C400.027,176.379,335.576,111.928,256.072,111.928z M256.072,329.569 c-40.696,0-73.687-32.99-73.687-73.686c0-40.697,32.991-73.687,73.687-73.687c40.695,0,73.686,32.989,73.686,73.687 C329.758,296.579,296.768,329.569,256.072,329.569z" fill="#FFF"/></svg>
          <span>Server</span>
        </li>
        <li id="nav-auto-dns" class="left-nav-button waves-effect waves-purple">
          <svg xmlns="http://www.w3.org/2000/svg" height="28" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path fill="#8c9eff" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
          <span>Publish Online</span>
        </li>
        <li id="nav-about" class="left-nav-button waves-effect waves-purple">
          <svg xmlns="http://www.w3.org/2000/svg" height="28" viewBox="0 -1 24 24" fill="#fff"><path d="M4 2c-1.093 0-2 .907-2 2v18.406l1.719-1.687L6.438 18H20c1.093 0 2-.907 2-2V4c0-1.093-.907-2-2-2H4zm0 2h16v12H5.594l-.313.281L4 17.563V4zm7 2v2h2V6h-2zm0 3v5h2V9h-2z"/></svg>
          <span>About</span>
        </li>
      </ul>

      <!-- Boot Server Button -->
      <div class="boot-server-button-wrapper">
        <div class="boot-server-flex-wrapper">
          <label class="autoboot-label">
            <input id="boot-server-checkbox" type="checkbox" checked="checked" />
            <span>Boot on startup</span>
          </label>
          <a id="boot-server-button" class="waves-effect waves-light btn blue accent-3">Boot Server</a>
        </div>
      </div>
    </div>

    <div id="switcherMain" class="main-right-col">
      <component v-bind:is="currentViewMain">
      </component>
    </div>
  </div>

  <script>
    const remote = require('electron').remote;
    const {ipcRenderer} = require('electron');
    const app = remote.app;
    const dialog = remote.require('electron').dialog;
    const axios = require('axios');
    const path = require('path');
    const fs = require('fs');
    const shell = require('electron').shell

    const apiEndpoint = 'https://api.mstream.io';
    const configFile = path.join(app.getPath('userData'), 'save/server-config.json');
    var loadJson = {};
    var bootFlag = false;

    // Open a tags in OS browser
    document.addEventListener('click', function (event) {
      if (event.target.tagName === 'A' && event.target.href.startsWith('http')) {
        event.preventDefault();
        shell.openExternal(event.target.href);
      }
    })

    try {
      if (fs.statSync(configFile).isFile()) {
        loadJson = JSON.parse(fs.readFileSync(configFile, 'utf8'));
      }
    } catch(error) {
      console.log('Failed To Load JSON');
    }

    if (!loadJson.port) {
      loadJson.port = 3000;
    }

    if (!loadJson.server) {
      loadJson.server = 'file';
    }

    if(!loadJson.logs){
      loadJson.logs = path.join(app.getPath('userData'), 'save');
    }

    console.log(loadJson)

    // if(!loadJson.directory){
    //   loadJson.directory = path.join(app.getAppPath(), 'examples/basic');
    // }

    // Auto DNS Testing
    if (!loadJson.ddns) {
      loadJson.ddns = {};
    } else {
      loadJson.ddns.tested = false;
      testAutoDns();
    }
    
    async function testAutoDns() {
      try {
        const loginRes = await axios({
          method: 'post',
          url: apiEndpoint + '/login', 
          headers: { 'accept': 'application/json' },
          responseType: 'json',
          data: {
            email: loadJson.ddns.email,
            password: loadJson.ddns.password
          }
        });
        loadJson.ddns.tested = true;
      } catch(err) {}
    }

    window.onload = function () {
      const serverView = Vue.component('server-view', {
        data() {
          return {
            selectInstance: null,
            lJson: loadJson
          };
        },
        template: '\
          <div>\
            <div class="row">\
              <div class="col s12 m6">\
                <div class="card">\
                  <div class="row row-mod">\
                    <div class="section-header">Select Server</div>\
                  </div>\
                  <div class="row row-mod server-select-row">\
                    <div class="col s12 port-form-container">\
                      <select  v-model="lJson.server" id="server-select">\
                        <option value="" disabled>Supported Servers</option>\
                        <option value="file">Basic File Server</option>\
                        <option value="bitwarden">Bitwarden RS</option>\
                        <option value="minecraft">Minecraft Server</option>\
                      </select>\
                      <label for="new-user-dirs">Select Server Type</label>\
                    </div>\
                  </div>\
                </div>\
              </div>\
              <div class="col s12 m6">\
                <div class="card">\
                  <div class="row row-mod">\
                    <div class="section-header">Network Details</div>\
                  </div>\
                  <div class="row row-mod">\
                    <div class="col s12 port-form-container">\
                      <div class="input-field">\
                        <input v-model="lJson.port" @blur="updateConfig()" id="server-port" type="number" class="validate" min="1" max="65535" step="1" required />\
                        <label for="server-port">Port #</label>\
                      </div>\
                    </div>\
                  </div>\
                </div>\
              </div>\
              <div class="col s12">\
                <div class="card">\
                  <div class="row row-mod">\
                    <div class="section-header">Web Directory</div>\
                  </div>\
                  <div class="row row-mod">\
                    <div class="col s12 port-form-container">\
                      <div class="input-field">\
                        <input v-on:click="selectLogsPath($event)" v-model="lJson.directory" @blur="updateConfig()" id="server-logs-folder" type="text" class="active" required />\
                        <label class="active" for="server-logs-folder">Logs Folder</label>\
                      </div>\
                    </div>\
                  </div>\
                  <div class="row row-mod clearfix">\
                    <a class="reset-defaults-link" href="#!" v-on:click="resetStorageValues" >Reset To Default Values</a>\
                  </div>\
                </div>\
              </div>\
            </div>\
          </div>',
        mounted: function () {
          this.selectInstance = M.FormSelect.init(document.querySelectorAll("#server-select"));
        },
        beforeDestroy: function() {
          this.selectInstance[0].destroy();
        },
        methods: {
          updateConfig: function() {
            fs.writeFileSync(configFile, JSON.stringify(loadJson), 'utf8');
          },
          resetStorageValues: function() {
          },
        }
      });

      const autoDnsView = Vue.component('auto-dns-view', {
        data() {
          return {
            pending: false,
            currentViewDdnsLogin: 'ddns-view-login',
            username: '',
            password: ''
          };
        },
        template: '\
          <div>\
            <div class="row auto-dns-selection">\
              <div class="col m6 s12 auto-dns-selection-item">\
                <div v-on:click="goToSignUp()" class="card auto-dns-card auto-dns-sign-up-item">\
                  <div class="section-header">Sign Up</div>\
                  <svg viewBox="0 0 128 128" height="120" width="100%" xmlns="http://www.w3.org/2000/svg"><path d="M94.894,68.493c-1.379-4.803-5.663-8.043-10.661-8.063h-0.631c0.146-3.979-0.709-7.176-2.677-10.032 c-2.403-3.498-5.605-5.677-9.788-6.663c-1.014-0.237-2.09-0.357-3.197-0.357c-4.143,0-9.78,1.83-13.333,6.942 c-1.344-0.545-2.772-0.822-4.249-0.822c-5.846,0-10.765,4.5-11.299,10.287c-0.633,0.333-1.228,0.719-1.773,1.149 c-1.67,1.311-2.967,3.049-3.752,5.025c-1.284,3.234-1.095,6.848,0.518,9.914c1.72,3.263,4.408,5.412,7.774,6.215l0.023-0.096 c0.691,0.135,2.776,0.148,9.075,0.188l5.487,0.037l0.012,0.071l0.348,0.003c3.083,0.029,9.591,0.055,15.166,0.076l4.354,0.018 l-0.024,0.042l6.333,0.045c0.85,0,1.507-0.01,2.126-0.029c3.362-0.11,6.442-1.754,8.451-4.513 C95.189,75.181,95.816,71.743,94.894,68.493z M43.606,62.33c-0.108-0.479-0.162-0.98-0.162-1.494c0-3.807,3.102-6.904,6.915-6.904 c1.844,0,3.579,0.724,4.884,2.039l0.184,0.186l0.247-0.087c0.697-0.244,1.267-0.758,1.565-1.407 c0.272-0.583,0.566-1.105,0.901-1.598c2.562-3.852,6.742-5.224,9.8-5.224c0.748,0,1.483,0.08,2.181,0.239 c3.054,0.717,5.386,2.302,7.132,4.846c1.572,2.293,2.148,5.027,1.813,8.601l-0.039,0.401c-0.078,0.745,0.174,1.503,0.693,2.082 c0.514,0.561,1.241,0.884,1.998,0.884h2.496c3.005,0.01,5.571,1.949,6.385,4.831c0.55,1.897,0.177,3.933-1.022,5.587 c-1.191,1.632-3.01,2.611-4.991,2.682c-0.573,0.019-1.188-0.026-1.983,0.019H45.094c-3.293-0.01-5.615-1.387-7.097-4.216 c-1.002-1.913-1.118-4.172-0.32-6.194c0.504-1.246,1.32-2.342,2.346-3.154l0.12-0.089c0.522-0.389,1.062-0.703,1.594-0.927 c0.036-0.013,0.109-0.031,0.261-0.073c0.359-0.102,0.902-0.256,1.423-0.587l0.247-0.156L43.606,62.33z" fill="#2E79BE"/><path d="M116.277,93.951c0.098-0.469,0.137-0.958,0.137-1.447v-59.98c0-5.357-4.047-9.677-9.032-9.677h-1.916 h-4.086H20.638c-4.985,0-9.032,4.321-9.032,9.677v59.98c0,0.489,0.039,0.977,0.098,1.447H2.535v1.505 c0,5.376,4.027,9.697,9.012,9.697h104.906c4.966,0,9.013-4.321,9.013-9.697v-1.505H116.277z M71.194,100.246 c0,1.036-0.684,1.877-1.564,1.877H58.37c-0.88,0-1.564-0.821-1.564-1.877v-1.212c0-1.056,0.684-1.896,1.564-1.896H69.63 c0.88,0,1.564,0.86,1.564,1.896V100.246z M107.577,93.951H20.423V32.368h79.093h3.882h4.179V93.951z" fill="#2D3E4F"/></svg>\
                </div>\
              </div>\
              <div class="col m6 s12 auto-dns-selection-item">\
                <div class="card auto-dns-card">\
                  <div class="section-header">Login</div>\
                  <form id="login-form" class="" @submit.prevent="login">\
                    <div class="row row-mod">\
                      <div class="input-field directory-name-field col s12">\
                        <input @blur="maybeResetForm()" v-model="username" id="login-username" required type="text" class="validate">\
                        <label for="login-username">Username</label>\
                      </div>\
                      <div class="input-field directory-name-field col s12">\
                        <input @blur="maybeResetForm()" v-model="password" id="login-password" required type="password" class="validate">\
                        <label for="login-password">Password</label>\
                      </div>\
                      <div class="col s12">\
                        <button :disabled="pending" class="btn green waves-effect waves-light login-button" type="submit">\
                          {{loginButtonText}}\
                        </button>\
                      </div>\
                    </div>\
                  </form>\
                </div>\
              </div>\
            </div>\
            <div class="row">\
              <div class="col s12">\
                <div class="card">\
                  <div class="row row-mod">\
                    <div class="section-header">Fog Machine RPN Service</div>\
                    <div class="col s12">\
                      <ul class="browser-default">\
                        <li>Get your own personal domain @ https://your-name.mstream.io</li>\
                        <li>Automatically configures SSL Encryption for your server</li>\
                        <li>State of the art \'Hole Punching\' software guarantees your server stays online as long as you have a working internet connection</li>\
                        <li>IP Obfuscation hides your IP address and adds an additional layer of security</li>\
                      </ul>\
                    </div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          </div>',
        computed: {
          loginButtonText: function() {
            if(this.pending) {
              return 'pending...';
            }
            return 'Login';
          }
        },
        methods: {
          goToSignUp: function() {
            shell.openExternal('https://mstream.io/reverse-proxy-network');
          },
          maybeResetForm: function() {
            if (this.username === '' && this.password === '') {
              document.getElementById("login-form").reset();
            }
          },
          login: async function() {
            try {
              this.pending = true;
              const loginRes = await axios({
                method: 'post',
                url: apiEndpoint + '/login', 
                headers: { 'accept': 'application/json' },
                responseType: 'json',
                data: {
                  email: this.username,
                  password: this.password
                }
              });
              const configRes = await axios({
                method: 'get',
                url: apiEndpoint + '/account/info',
                headers: { 'x-access-token': loginRes.data.token, 'accept': 'application/json' },
                responseType: 'json'
              });
              loadJson.ddns = {
                email: this.username,
                password: this.password,
                token: loginRes.data.token,
                tested: true,
                url: configRes.data.subdomain + '.' + configRes.data.domain
              };
              fs.writeFileSync(configFile, JSON.stringify(loadJson), 'utf8');
              iziToast.success({
                title: 'Logged In',
                position: 'topCenter',
                timeout: 3500
              });
              vm.currentViewMain = 'auto-dns-logged-in-view';
              this.pending = false;
            } catch(err) {
              this.pending = false;
              iziToast.warning({
                title: 'Failed to Login',
                position: 'topCenter',
                timeout: 3500
              });
            }
          }
        }
      });

      const autoDnsLoggedInView = Vue.component('auto-dns-logged-in-view', {
        template: '\
          <div class="row">\
            <div class="col s12">\
              <div class="card">\
                <div class="row row-mod">\
                  <div class="section-header">Fog Machine RPN</div>\
                  <div class="col s12">\
                    <div>You are logged in as: <b>{{loadJson.ddns.email}}</b></div>\
                    <div>Your Public URL: <b>https://{{loadJson.ddns.url}}</b></div>\
                    <br>\
                    <div>SSL Encryption: <b>Enabled</b></div>\
                    <br>\
                    <div v-if="this.$parent && this.$parent.$el && this.$parent.$el.id === \'switcherMain\'"><a v-on:click="logout()" href="javascript:;">Logout</a></div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          </div>',
        methods: {
          logout: function() {
            loadJson.ddns = {};
            vm.currentViewMain = 'auto-dns-view';
          },
        }
      });

      const aboutView = Vue.component('about-view', {
        template: '\
          <div>\
            <div class="row">\
              <div class="col s12">\
                <div class="card">\
                  <div class="about-content-section">\
                    <div class="about-content-header">Developed By</div>\
                    <br>\
                    <div class="about-content-body">Paul Sori</div>\
                    <div class="about-content-body">paul@fogmachine.io</div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          </div>',
      });

      const bootView = Vue.component('boot-view', {
        template: "\
          <div>\
            <div id='bars'>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
              <div class='bar'></div>\
            </div>\
            <div id='boot-server-text' class='boot-server-text'>\
              Booting Server\
            </div>\
            <div id='post-boot-content'></div>\
          </div>",
      });

      var vm = new Vue({
        el: '#switcherMain',
        components: {
          'server-view': serverView,
          'boot-view': bootView,
          'auto-dns-view': autoDnsView,
          'about-view': aboutView
        },
        data: {
          currentViewMain: false
        }
      });

      vm.currentViewMain = 'server-view';

      document.getElementById("nav-server").onclick = function(){
        if(bootFlag === true) {
          return;
        }
        vm.currentViewMain = 'server-view';
        resetNav(this);
      }

      document.getElementById("nav-auto-dns").onclick = function(){
        if(bootFlag === true) {
          return;
        }
        vm.currentViewMain = (loadJson.ddns.tested) ? 'auto-dns-logged-in-view' : 'auto-dns-view';
        resetNav(this);
      }

      document.getElementById("nav-about").onclick = function(){
        if(bootFlag === true) {
          return;
        }
        vm.currentViewMain = 'about-view';
        resetNav(this);
      }

      function resetNav(that) {
        document.querySelectorAll('.left-nav-button').forEach((el) => {
          el.classList.remove("nav-selected");
        });

        if (that) {
          that.classList.add('nav-selected');
        }
      }

      document.getElementById("boot-server-button").onclick = function(){
        if(!loadJson.port) {
          iziToast.warning({
            title: 'You must set the port before booting the server',
            position: 'topCenter',
            timeout: 3500
          });
          resetNav(document.getElementById("nav-server"));
          vm.currentViewMain = 'server-view';
          return;
        }

        if(bootFlag === true) {
          return;
        }

        vm.currentViewMain = 'boot-view';
        document.getElementById("boot-server-button").innerHTML = 'Booting...'
        bootFlag = true;
        resetNav();
        
        if (document.getElementById("boot-server-checkbox").checked === true) {
          loadJson.autoboot = true;
        }
        document.getElementById("boot-server-checkbox").disabled = true;

        // save
        fs.writeFileSync(configFile, JSON.stringify(loadJson), 'utf8');

        setTimeout(() => {
          ipcRenderer.send('start-server', loadJson);
          setTimeout(() => {
            document.getElementById("boot-server-button").innerHTML = 'Success';
            document.getElementById("boot-server-text").innerHTML = 'Server Booted!';

            // RPN Link
            let rpnLink = '';
            if (loadJson.ddns.tested === true) {
              rpnLink += '<div>Your server is available online at: <a href="https://'+loadJson.ddns.url+'">https://' + loadJson.ddns.url + '</a></div>';
            }

            const localhostAdd = loadJson.ssl && loadJson.ssl.cert && loadJson.ssl.key ? 'https' : 'http' + '://localhost:' + loadJson.port;
            document.getElementById("post-boot-content").innerHTML = '<div class="row">\
              <div class="col s12">\
                <div class="card">\
                  <div class="about-content-section">\
                    <div>This window will automatically close in <span id="countdown">30</span> seconds to save on memory</div>\
                    <br>\
                    <div>Test your server locally at: <a href="'+localhostAdd+'">'+localhostAdd+'</a></div>\
                    '+rpnLink+'\
                  </div>\
                </div>\
              </div>\
            </div>';

            var countdown = 30;
            setInterval(() => {
              countdown--;
              if(countdown === 0){
                var window = remote.getCurrentWindow();
                window.close();
              }else{
                document.getElementById("countdown").innerHTML = countdown;
              }
            }, 1000);
          }, 2500);
        }, 2500);
      }
    }
  </script>
</body>
</html>